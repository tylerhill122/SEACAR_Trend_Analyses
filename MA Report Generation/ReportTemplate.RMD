---
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
    toc: TRUE
    toc_depth: 3
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    dev: png
    keep_md: yes
  pdf_document:
    toc: TRUE
    toc_depth: 3
    dev: png
    extra_dependencies: ["float"]
    keep_md: yes
    fig_crop: no
urlcolor: blue
title: '`r paste(ma)`'
subtitle: "SEACAR Habitat Analyses"
geometry: margin=0.75in
---

```{r libraries, message=FALSE, warning=FALSE, echo=FALSE}
library(knitr)
library(gridExtra)
library(ggpubr)
library(glue)
library(kableExtra)
library(leaflet)
library(mapview)
library(magick)
library(cowplot)
options(scipen=999)
knitr::opts_chunk$set(
   warning=FALSE,
   message=FALSE,
   echo=FALSE,
   dpi=200
   )
```



```{r descriptive snippet, results='asis'}

# Descriptive snippet to provide VQ & threshold filtering info
cat(knitr::knit_child('snippet.Rmd', quiet=TRUE))

```


```{r plotting WQ_Discrete, warning=FALSE, fig.height=9, fig.width=10, results="asis"}

if(in_discrete){
  ma_df <- managed_area_df %>% filter(ManagedAreaName == ma)
  p_inc <- unique(ma_df$Parameter)
  d_inc <- unique(ma_df$Depth)
  a_inc <- unique(ma_df$Activity)

  cat("\\newpage")
  cat("# Water Quality - Discrete  \n")
  
  cat("The following files were used in the discrete analysis:  \n\n")
  for(file in wq_discrete_files){
    cat(paste0("* *", file, "*\n"))
    cat("  \n")
  }
  
  for (param in p_inc){

    # load overall discrete data
    data <- as.data.frame(load_data_table(param, table="data"))
    
    # getting full parameter & unit names
    parameter <- unique(data$ParameterName)
    unit <- unique(data$ParameterUnits)
  
    # defining labels for y-axis
    y_labels <- ifelse(param == "pH", parameter, paste0(parameter, " (" , unit, ")"))
    
    cat("  \n")
    subtitle <- glue("## {parameter}")
    cat(subtitle, "\n\n")
    
    #Because secchi depth is does not have a bottom measurement, this statement skips
    #Secchi depth for bottom
    if (param == "Secchi"){
      depth <- "Surface"
    } else {
      depth <- "All"
    }
    
    # Choosing which analyses to plot, when to combine 
    if (param == "ChlaC" |
        param == "Chla" |
        param == "CDOM" |
        param == "TN" |
        param == "TP") {activity = "Lab"} else if (
          param == "DO" |
          param == "DOS" |
          param == "pH" |
          param == "Secchi" |
          param == "TempW") {activity = "Field"} else if (
            param == "Sal" |
            param == "TSS" |
            param == "Turb") {activity = "All"}
  
    if (activity == "All") {
      activity_label <- "Lab and Field Combined"
    } else if (activity == "Field" | activity == "Lab") {
      activity_label <- activity
    }
  
    if (depth == "All") {
      depth_label <- "All Depths"
    } else if (depth == "Surface") {
      depth_label <- "Surface"
    }
    
    # Exception to include TN calculation logic
    # Loads external .Rmd for ease of formatting
    if (param == "TN") {
      cat(knitr::knit_child('TN_Calculation_Description.Rmd', quiet=TRUE))
      cat("  \n")
      cat("\\newpage")
    }
    
    ## Begin Plotting Discrete ##
    
    # Produce discrete SKT-trendplots
    plot_trendlines(param, activity, depth, activity_label, depth_label, y_labels, parameter, data)
    
    # Produce boxplots
    # plot_boxplots(param, activity, depth, activity_label, depth_label, y_labels, parameter, data)
  
    # Produce VQ-barplots
    plot_vq_barplot(param, activity, depth, activity_label, depth_label, y_labels, parameter, data)
    
  }
}

```


```{r plotting WQ_Continuous, warning=FALSE, fig.height=9, fig.width=10, results="asis", eval = TRUE}

# extract region for each MA to determine which cont. file to load
region <- MA_All %>% filter(ManagedAreaName == ma) %>% pull(Region)

if(in_continuous){
  
  cat("\\newpage")
  cat("# Water Quality - Continuous  \n")
  
  cont_file_list <- list.files("data/cont", full=TRUE)
  cat("The following files were used in the continuous analysis:  \n\n")

  for (param in cont_params_long){
    p <- str_replace_all(param, " ", "_")
    par_reg <- paste0(p, "_", region)
    file_name <- str_split(str_subset(cont_file_list, par_reg), "data/cont/")[[1]][2]
    
    cat(paste0("* *", file_name, "*\n"))
    cat("  \n")
  }
  
  for (i in 1:length(cont_params_short)){
    param <- cont_params_short[i]
    
    # load cont data for a given region containing MA
    cont_data <- as.data.frame(load_cont_data_table(param, region, table="data"))
    
    # run first time only to display stations
    if (i==1) {
      station_count_table(cont_data)
      cat("  \n")
    }
    
    # getting full parameter & unit names
    parameter <- cont_param_df %>% filter(param_short == param) %>% pull(parameter)
    unit <- cont_param_df %>% filter(param_short == param) %>% pull(unit)
    
    # defining labels for y-axis
    y_labels <- ifelse(param == "pH", parameter, paste0(parameter, " (" , unit, ")"))
    
    ###########################
    ### Begin Plotting Cont ###
    ###########################
    
    cat("\\newpage")
    
    plot_cont(param, y_labels, parameter, cont_data)
  }
}

```


```{r SAV scope_plots, warning=FALSE, fig.height=15, fig.width=12, results="asis", echo=FALSE}

if(in_sav){
  cat("\\newpage")
  cat("# Submerged Aquatic Vegetation  \n")
  cat(paste0("The data file used is: **", sav_file_short,"**"))
  
  cat("  \n")
  sav_scope_plots(ma_abrev)
}

```


```{r plotting SAV, warning=FALSE, fig.height=9, fig.width=10, results="asis", eval=TRUE, echo=FALSE}


if(in_sav){

  # cat("  \n")
  # sav_maps(ma, ma_abrev)
  
  cat("  \n")
  plot_sav_trendplot(ma_abrev)
  
  cat("  \n")
  plot_sav_barplot(ma_abrev)
  
  cat("  \n")
  ggplot_gam(ma, "combined")
  cat("  \n")
}


```



```{r plotting nekton, warning=FALSE, fig.height=6, fig.width=8, results="asis"}


if(in_nekton){
  
  cat("# Nekton  \n")
  cat(paste0("The data file used is: **", nekton_file_short,"**"))
  cat("  \n")
  plot_nekton(ma, MA_Y_Stats_nek, MA_Ov_Stats_nek)
  cat("  \n")
  
}


```



```{r plotting Coral, warning=FALSE, fig.height=6, fig.width=8, results="asis"}

if(ma %in% coral_pc_MA_Include | ma %in% coral_sr_MA_Include){
  cat("# Coral Reef \n")
  cat(paste0("The data file used is: **", coral_file_short,"**"))
  cat("  \n")
  
  if(ma %in% coral_pc_MA_Include){
    plot_coral_pc(ma, data_pc, lme_plot_pc, MA_Ov_Stats_pc)
    cat("  \n")
  }
  
  if(ma %in% coral_sr_MA_Include){
    plot_coral_sr(ma, MA_Y_Stats_sr, MA_Ov_Stats_sr)
    cat("  \n")
  }
}

```



```{r plotting coastalwetlands, warning=FALSE, fig.height=6, fig.width=8, results="asis"}

if(in_cw){
  
  cat("# Coastal Wetlands  \n")
  cat(paste0("The data file used is: **", cw_file_short,"**"))
  cat("  \n")
  plot_cw(ma, MA_Ov_Stats_cw, MA_Y_Stats_cw)
  cat("  \n")
  
}

```